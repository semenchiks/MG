<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ожидаем ответы</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:,">
  <style>
    html, body { overflow: auto; }
    .page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }
    .panel { width: 100%; max-width: 720px; background: #ffffff; border: 3px solid var(--yellow-primary); border-radius: 16px; box-shadow: 0 8px 24px rgba(255,224,0,0.25); padding: 24px; text-align: center; }
    .title { font-weight: 800; font-size: 22px; margin-bottom: 12px; }
    .loader { display: inline-flex; gap: 8px; margin: 10px 0 22px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--yellow-primary); animation: pulse 1.2s infinite ease-in-out; }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes pulse { 0%, 80%, 100% { transform: scale(0.6); opacity: .5; } 40% { transform: scale(1); opacity: 1; } }
    .metrics { display: grid; gap: 10px; margin-top: 8px; }
    .metric { font-size: 18px; font-weight: 700; }
    .metric span { font-weight: 800; }
    /* Плавное скрытие загрузки и метрик */
    .loader, .metrics { transition: opacity .6s ease, transform .6s ease; }
    .fade-out { opacity: 0 !important; transform: translateY(8px); pointer-events: none; }
    /* Облако тегов */
    .cloud { display: none; margin-top: 24px; min-height: 260px; position: relative; overflow: hidden; opacity: 0; transition: opacity .8s ease .15s; contain: layout paint; }
    .cloud.show { display: block; }
    .cloud.visible { opacity: 1; }
    .tag { position: absolute; padding: 6px 10px; border-radius: 999px; background: #fff; border: 2px solid var(--yellow-primary); font-weight: 700; white-space: nowrap; box-shadow: 0 6px 20px rgba(255,224,0,.25); will-change: transform, opacity, filter; }
    /* Плавное поэтапное появление + небольшое парение */
    .cloud-enter { animation: cloudIntro .9s cubic-bezier(.22,.61,.36,1) both; animation-delay: var(--delay, 0s); }
    @keyframes cloudIntro { 0% { opacity: 0; transform: translateY(12px) scale(.9) rotate(var(--rot, 0deg)); filter: blur(6px); } 60% { opacity: 1; transform: translateY(-3px) scale(1.03) rotate(calc(var(--rot, 0deg) * -0.3)); filter: blur(0); } 100% { opacity: 1; transform: translateY(0) scale(1) rotate(0); } }
    .float { animation: floatY 6s ease-in-out infinite; animation-delay: var(--floatDelay, 1s); }
    @keyframes floatY { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
  </style>
</head>
<body>
  <div class="page">
    <div class="panel" role="region" aria-label="Ожидание ответов">
      <div class="title">Ожидаем ответов</div>
      <div class="loader" aria-hidden="true">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div class="metrics">
        <div class="metric">Отвечающих пользователей: <span id="responding-count">0</span></div>
        <div class="metric">Пользователей, давших ответ: <span id="answered-count">0</span></div>
      </div>
      <div id="tags-cloud" class="cloud" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // Подключаем Socket.IO и слушаем статистику
    (function(){
      const script = document.createElement('script');
      script.src = 'https://cdn.socket.io/4.5.0/socket.io.min.js';
      script.onload = () => {
        const socket = io();
        const respondingSpan = document.getElementById('responding-count');
        const answeredSpan = document.getElementById('answered-count');
        const cloud = document.getElementById('tags-cloud');
        const title = document.querySelector('.title');
        const loader = document.querySelector('.loader');
        const metrics = document.querySelector('.metrics');
        socket.on('bubble_stats', (stats) => {
          if (respondingSpan) respondingSpan.textContent = stats.answering ?? 0;
          if (answeredSpan) answeredSpan.textContent = stats.answered ?? 0;
        });

        function renderCloud(tags) {
          if (!cloud) return;
          cloud.innerHTML = '';
          cloud.classList.add('show');
          // Раскладка по облаку: уникальные теги, случайные позиции, поэтапное появление
          const rectWidth = cloud.clientWidth || 600;
          const rectHeight = cloud.clientHeight || 260;
          // Не объединяем одинаковые ответы — показываем столько раз, сколько прислали
          const cleaned = tags.map(t => String(t).trim()).filter(Boolean);
          cleaned.forEach((t, idx) => {
            const el = document.createElement('span');
            el.className = 'tag cloud-enter float';
            el.textContent = t;
            const size = 14 + Math.floor((idx % 8) * 2);
            el.style.fontSize = size + 'px';
            const x = Math.floor(Math.random() * Math.max(50, rectWidth - 120));
            const y = Math.floor(Math.random() * Math.max(30, rectHeight - 40));
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            // Случайная задержка и легкий поворот
            const delay = (idx * 180) + Math.floor(Math.random() * 300);
            const rot = (Math.random() * 6 - 3).toFixed(2);
            el.style.setProperty('--delay', `${delay}ms`);
            el.style.setProperty('--rot', `${rot}deg`);
            el.style.setProperty('--floatDelay', `${800 + delay}ms`);
            cloud.appendChild(el);
          });
          // Отдельно плавно проявляем само облако, чтобы теги не возникали резко
          requestAnimationFrame(() => {
            cloud.classList.add('visible');
          });
        }

        socket.on('bubble_ready', (payload) => {
          if (title) title.textContent = 'Все ответы получены';
          if (loader) loader.classList.add('fade-out');
          if (metrics) metrics.classList.add('fade-out');
          // Даем анимации скрытия завершиться, затем показываем облако
          const fadeMs = 700;
          setTimeout(() => {
            if (loader) loader.style.display = 'none';
            if (metrics) metrics.style.display = 'none';
            if (cloud) renderCloud(Array.isArray(payload?.tags) ? payload.tags : []);
          }, fadeMs);
        });
      };
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>

